<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<script src="https://cdn.anychart.com/releases/8.7.1/js/anychart-base.min.js" type="text/javascript"></script>
	<title>Freezer Temp</title>
	<style>
		form label {
			display: block;
		}
	</style>
</head>

<body>
	<h1>Freezer Temp</h1>
	<p>
		Current temperature: <span id="temp-span">(getting data from sensor)</span>
	</p>
	<p>
		Current state: <span id="state-span">(getting data from gpio)</span>
	</p>
	<p>
		Timespan:
		<form action="">
			<label><input type="radio" name="timespan" value="15" onclick="radioClick(15)">15 minutes</label>
			<label><input type="radio" name="timespan" value="30" onclick="radioClick(30)">30 minutes</label>
			<label><input type="radio" name="timespan" value="60" onclick="radioClick(60)">1 hour</label>
			<label><input type="radio" name="timespan" value="180" onclick="radioClick(180)">3 hours</label>
			<label><input type="radio" name="timespan" value="480" onclick="radioClick(480)">8 hours</label>
		</form>
	</p>
	<div id="container" style="width: 500px; height: 400px;"></div>
	<script>
		var sensorId = "28-00000b91bae7";

		let minutesOfHistory = null;

		// Trigger default timespan, 3 hours
		document.getElementsByTagName("input")[3].click();

		function radioClick(minutes) {
			const inputs = Array.from(document.getElementsByTagName("input"));
			inputs.forEach(x => x.setAttribute("disabled", "false"));
			minutesOfHistory = minutes;
			readDisplayLoop(() => {
				inputs.forEach(x => x.removeAttribute("disabled"));
			});
		}

		// Setup chart
		var temperatureData = [];
		var chart = anychart.line();
		var intervalInSeconds = 30;
		chart.title("Temperature over time");
		chart.container("container");

		function getTemperatureHistory(callback, minutes) {
			let url = "/temperature-history"
			if (!!minutes) {
				url += "?minutes=" + minutes;
			}
			fetch(url)
				.then(response => response.json())
				.then(data => callback(data));
		}

		function getCoolingState(callback) {
			fetch("/state")
				.then(response => response.json())
				.then(data => callback(data));
		}

		function updateView(temperature, state) {
			var fahrenheit = temperature * (9 / 5) + 32
			document.querySelector("span#temp-span").innerText = temperature + "°C, " + fahrenheit.toFixed(1) + "°F";
			document.querySelector("span#state-span").innerText = state.isCooling ? "Running / Cooling" : "Not Running";
		}

		function readDisplayLoop(callback) {
			getTemperatureHistory(temperatureData => {
				getCoolingState(state => {
					updateView(temperatureData[temperatureData.length - 1].tempC, state);
				});
				chart.data(temperatureData);
				chart.draw();

				// do things when reading is done
				!!callback && callback();
			}, minutesOfHistory);
		}

		readDisplayLoop();

		setInterval(readDisplayLoop, intervalInSeconds * 1000);
	</script>
</body>

</html>